<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta http-equiv="X-UA-Compatible" content="ie=edge"/><meta http-equiv="X-Frame-Options" content="DENY"/><meta http-equiv="X-XSS-Protection" content="1; mode=block"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/><meta name="keywords" content="[&quot;Bitcoin&quot;,&quot;batching&quot;,&quot;transaction&quot;,&quot;fees&quot;]"/><meta name="description" content="With GroupHug, we bundle escrow releases for lower transaction fees. Opt in, wait a tad, save more. You're in control, switch anytime.
"/><meta property="og:locale" content="en"/><meta property="og:site_name"/><meta property="og:title" content="Peach Bitcoin Exchange - Buy and Sell Bitcoin Anonymously and Without KYC"/><meta property="og:description" content="Peach Bitcoin - Buy Bitcoin with gift card, no verification. Exchange peer to peer for anonymous transactions. Learn how to buy and sell Bitcoin privately and without KYC. Manage your Bitcoin securely with our non-KYC platform."/><meta property="og:type" content="website"/><meta property="og:image" content="/img/blog/group-hug/teaser.png"/><meta property="og:image:secure_url" content="/img/blog/group-hug/teaser.png"/><meta property="og:image:width" content="1296"/><meta property="og:image:height" content="678"/><meta name="twitter:site" content="@peachbitcoin"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="GroupHug For Everyone · Peach Bitcoin"/><meta name="twitter:description" content="Peach Bitcoin - Buy Bitcoin with gift card, no verification. Exchange peer to peer for anonymous transactions. Learn how to buy and sell Bitcoin privately and  without KYC. Manage your Bitcoin securely with our non-KYC platform."/><meta name="twitter:image" content="/img/blog/group-hug/teaser.png"/><meta name="msapplication-TileColor" content="#F56522"/><meta name="cf-2fa-verify" content="e22767e30dc139c"/><meta name="theme-color" content="#F56522"/><link rel="preload" as="font" crossorigin="crossorigin" href="/fonts/baloo-2-v16-latin-regular.woff2"/><link rel="preload" as="font" crossorigin="crossorigin" href="/fonts/baloo-2-v16-latin-600.woff2"/><link rel="preload" as="font" crossorigin="crossorigin" href="/fonts/baloo-2-v16-latin-800.woff2"/><link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"/><link rel="icon" href="/img/favicon/favicon.svg"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#F56522"/><link rel="stylesheet" href="/css/main-fadd3e7623af117338aa3005f4c1cd65.css"/><title>GroupHug For Everyone · Peach Bitcoin</title><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KQHJRQKH');</script></head><body id="blog-grouphug-for-everyone"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQHJRQKH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><header class="header header-container" id="header"><div class="wrap"><a class="logo-link brand" href="/"><img class="logo logo" src="/img/peach-bitcoin-145cd6c0079ccacc9c70c892060964d1.svg" alt="Peach Bitcoin"/></a><input id="show-menu" type="checkbox"/><label class="nav-toggle-label" id="nav-toggle" for="show-menu"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path class="line--1" d="M0 70l28-28c2-2 2-2 7-2h64"></path><path class="line--2" d="M0 50h99"></path><path class="line--3" d="M0 30l28 28c2 2 2 2 7 2h64"></path></svg></label><nav class="nav"><a href="/how-it-works/">Buy BTC without KYC</a><a href="/for-meetups/">Buy BTC with cash</a><a href="/for-businesses/">Sell BTC</a><a href="/blog/">Blog</a><a href="/support/">Support</a><div class="language-selector"><input class="checkbox" type="checkbox" id="language-toggle"/><label class="language-label" for="language-toggle"><span class="language-text">English</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="white" style="margin-left: .25rem;"><path d="M7 10l5 5 5-5z"></path></svg></label><ul class="language-dropdown"><li><a href="/"> <span>English</span></a></li><li><a href="/es"> <span>Español</span></a></li><li><a href="/de"> <span>Deutsch</span></a></li><li><a href="/it"> <span>Italiano</span></a></li><li><a href="/fr"> <span>Français</span></a></li><li><a href="/pt"> <span>Português</span></a></li></ul></div></nav></div></header><main class="main" id="main"><div id="header-anchor"></div><section class="wrap"><div class="content-wrap post"><h1 id="grouphug-for-everyone">GroupHug For Everyone</h1>
<p>After some time and a lot of work we are stoked to bring to you a new release with many quality of life improvements and one big systemic change.
I will say right away: This change is intended to be under the hood and subtle. Users should not really feel it, and when they notice it, we hope that it will be in a way that is pleasantly surprising. But let's back up a little bit first and let me take you on a brief tour about Peach - the app but also the business.</p>
<p>When you buy Bitcoin on Peach, 2% of that trade amount goes to Peach as a service fee. The way this works on a technical level is, that a transaction is created which has two outputs:</p>
<ul>
<li>the amount that the buyer receives</li>
<li>the 2% Peach fee</li>
</ul>
<p><img src="/img/blog/grouphug-for-everyone/one-input-two-outputs.png" alt="">
As you might know, Bitcoin transactions also have another fee that you have to pay: The mining fee.
This mining fee is not dependent on the <em>amount</em> you are sending, but the <strong>size of the transaction</strong>. Think of it like sending a picture of a pile of cash. It doesn't really matter how much cash is in the picture, it will still take up the same amount of storage.</p>
<p>Both of these pictures are 1MB in size:</p>
<p><img src="/img/blog/grouphug-for-everyone/one-mb-dollar.jpg" alt="">
<img src="/img/blog/grouphug-for-everyone/one-mb-million-dollars.jpg" alt=""></p>
<p>In the same way, a simple bitcoin transaction, like in our case 1 input and 2 outputs, will cost you more or less the same amount, no matter how much you buy. But if there were some way to reduce the number of outputs, you would pay even less.</p>
<p>Now some members of our <a href="https://t.me/peachtopeach">telegram community</a> and other passionate Peaches might say, that this is what we already have, and in fact that is right!
In September 2023, after celebrating the 1 year birthday of Peach, we did release "Grouphug" - a way in which transactions on Peach would be <em>batched</em> in a way that it would allow our users to save <em>up to 23%</em> in mining fees by effectively sharing the peach fee output.</p>
<p>This is what we are rethinking and re-envisioning with this release!
Bitcoin is magic - but it is useless if you let somebody else be in charge of it as opposed to using it yourself. You can read <a href="https://peachbitcoin.com/blog/if-bitcoin-goes-to-1-million/">a rant about that here.</a>
Peach is built on this realization and with a very clear goal: We want to empower as many people as possible to use this magic in its full glory. We realize that Bitcoin is something fundamentally new and something unfamiliar so one of the most important things we offer is <em>strong defaults</em>. Peach makes it easy not to fuck things up.</p>
<p>However there were a couple of problems with the way Peach was operating and the default experience it was giving our users as well as the conceptualization of batching which became especially apparent after the fee storm during the halving.</p>
<p><img src="/img/blog/grouphug-for-everyone/halving-fee-storm.svg" alt="">
<img src="/img/blog/grouphug-for-everyone/high-fees-meme.jpeg" alt=""></p>
<p>As mentioned before, Peach collects 2% per trade, and these fees have to be consolidated at some point. However looking at the mining fees we came to the realization: We were completely fucking ourselves. When we reviewed the impact these consolidations had on the profitability of peach, the mining fee was around 100 sat/vB, something which we have gotten used to seeing.
At that fee rate, any trade with a service fee less than 4100 sats was for sure loosing us money, and at a 2% fee rate this meant that the absolute minimum amount we should allow to be traded on Peach was 205 000 sats (and our minimum was around 1/10th of that).
Again all of this comes from having to pay for consolidation: If we had 10 trades for 20 500 sats that were all grouphugged, giving us a single utxo worth 4100 sats, all would be good again.</p>
<p>We quickly realized the powerful tool we already had in our hands to solve our problems and we dreamt of a world were everyone would be a group-hugger.</p>
<p>The setup we had had before was using 6 buckets for different fee rates and batched them every 12 hours. Very often this lead to 'batched' transactions that weren't really batched at all. Many buckets would just have a single, or very few participants, so you wouldn't really save that much on fees, if at all. Also from a business perspective this meant, that the amount peach would receive as a service fee would be relatively low hence also costly to consolidate.</p>
<p>We reminded ourselves about the goal of Peach: Enabling the masses to experience the magic of Bitcoin by not compromising on any core values and offering strong defaults.
Looking at our statistics for fee preference, we saw that virtually all users had just stuck with the default fee Peach provides, further confirming that this is ultimately what our users also want. Most users stack to save. They just want to receive their sats relatively quickly and relatively cheaply and don't care too much about the details to get there.</p>
<p>On the basis of this we simplified and improved batching to the following model:
1 bucket with as many participants as possible. The batch happens earliest after 24 hours and the minimum fee rate used by the bucket is the half hour fee. We also wait for the peach fee amount to reach a minimum threshold before broadcasting the transaction.
We are also making <strong>batching the default!</strong>
This does mean that payouts will take slightly longer than before, however we believe that again, our users want to stack sats with a low time preference and if we can save them fees by delaying payouts slightly users will be happy.
If this assumption does not fit you, no worries! You can still opt out of batching at any point in time and have your release transaction immediately be broadcast. The only thing that changes here is that we now ask the user to cover the additional costs this implies for peach, meaning specifically the added consolidation cost of the peach fee we collect from that trade. We calculate this using the following formula: 41 * halfHourFee. At the time of writing, the half hour fee is 10 sat/vB, so this would mean an extra 410 sats paid to Peach.
This is based on the absolute <a href="https://en.bitcoin.it/wiki/Techniques_to_reduce_transaction_fees#Consolidation">minimum size per input.</a></p>
<p>Another thing we realized during the fee storm is that we need to have some sort of protection mechanism against fee spikes, where buyers end up paying much more than expected.
Going forward, every trade will have a maximum mining fee, which peach sets at 10% of the trade amount by default. Anything beyond that we assume is the result of fee spikes or user error (for example buying a very small amount without being aware of the mining fees that will have to be paid).
This simply means that if after the match the fees spike, Peach will not go beyond this 10% limit.
If however this 10% limit is already exceeded at the time of match, Peach will simply show a warning on the match card.</p>
<figure><img src="/img/blog/grouphug-for-everyone/fee-warning.png" alt=""></figure>
<p>If you still decide to proceed with the trade, let's say at a 15% mining fee, this will be set as the new maximum. In other words you will not pay more than 15%, but if the fees drop you will pay even less.</p>
<p>So lets summarize:
Going forward you will save much more on mining fees, because we assume that we will have a lot more transactions in our buckets. If you still want peach to broadcast the transaction instantly we will ask you to pay for the added costs to Peach, so that we don't rek ourselves. Peach will also protect buyers from paying a significant amount of mining fees without being aware of this.
In doing all of this we hope that the default experience for our users will be even smoother and as mentioned in the very beginning, they will notice these changes only as a pleasant surprise when seeing that they paid less in mining fees than expected or when it protects you from spending a huge chunk of your trade on mining fees without realizing it.
If you're interested in the details you can check the FOSS code <a href="https://github.com/Peach2Peach/groupHug/tree/6f1cb023c972eec1fc73989e39a53378313d7394">here</a>.</p>
<p>HAPPY PEACHING!</p>
<h2 id="faq">FAQ:</h2>
<ul>
<li>Can I join GroupHug as an external actor?
<ul>
<li>Yes! The new GroupHug a flat 2% fee for any participants. So compared to the previous model, participating gets more costly by default, <strong>however:</strong> because we assume that by 1. reducing the number of buckets, 2. increasing the minimum wait time and 3. making batching the default for all peach users, the potential 23% on mining fees you save will become much more realistic to reach (the more participants, the more you save).
Practically this makes batching particularly attractive, if you have a small value transaction that you want to broadcast during fee spikes.</li>
</ul>
</li>
<li>what’s the minimum threshold that you set before broadcasting the transaction?
<ul>
<li>When Peach the company uses its revenue, we have to do a consolidation and as mentioned, this means extra costs. The threshold that we set is based on the loss, Peach would incur by consolidating at the time of the batch. We have defined our acceptable loss limit at 2% of the transaction.
So each peach fee utxo produced by the batching server will wait for either the fees to drop or the number of participants to grow so this threshold gets reached.</li>
</ul>
</li>
<li>Can I follow the batch to see how many participants there are?
<ul>
<li>Yes! For now it is a very minimal display in the peach-app that just shows you the number of participants, but you can think of the batching server as its own little mempool. So with the amount of cool animations you can find for the mempool, it's not hard to imagine similar, more detailed overviews, to be added in the future</li>
</ul>
</li>
<li>What if the batch is not filled after 24h, do you still release?
<ul>
<li>We check the status of the batch every minute. If after 24h the threshold isn't met, we simply continue waiting for either more participants or lower fees. If for some reason fees just keep going up, or nobody else joins the batch, we will broadcast it after 1 week.
Remember: If you don't want to wait any longer, you can always opt out!</li>
</ul>
</li>
<li>How do I know how much mining fees I am going to pay and how much I am going to save?
<ul>
<li>The mining fees used are the half hour fee at the time when the seller confirms the payment. The more participants in a batch, the more you will save, since the peach fee output effectively gets shared among all participants.</li>
</ul>
</li>
<li>I want my sats asap, How do I opt-out from Batching?
<ul>
<li>Simple: Just go to your settings in the peach app, open the transaction batching section and click on the toggle. You will have to be on the newest version (0.5.0) though, since we want to make sure the user is aware that this means slightly higher costs.</li>
</ul>
</li>
<li>What about Free Trades?
<ul>
<li>Free Trade payouts will be broadcasted instantly, since there is no peach fee output. This means that you save on mining fees even more and get the benefit of instant broadcasts. You also get a quite significant privacy benefit from the peach fee output not existing! This is a bit of a rabbithole we will explore more in the future but a free trade basically is a number of magnitudes more private than a normal trade. So refer users to Peach to stack points and get free trades!</li>
</ul>
</li>
</ul>
<p>As a final note lets also make one thing clear: This is a new foundation, but it's by no means the final destination. We already have ideas on how to make this model even better, build on top of it and realize the new opportunities it creates.
If you have something you want to share also, we'd love to <a href="https://t.me/peachtopeach">hear from you</a>!!</p>
<p class="date">June 10th, 2024</p><p class="tags">Tagged with:<a href="/blog/tag/code">Code</a><a href="/blog/tag/product">Product</a></p><p><a href="/blog/">All blog posts</a></p></div></section></main><footer class="footer" id="footer"><div class="wrap"><div class="logo-section"><div class="logo"><img class="logo-image" src="/img/peach-footer-logo-e28fd7e07f654f43afd63c9b6ace3cdb.svg" alt="Peach logo"/><span>Made in Switzerland <img src="/img/flags/switzerland-icon.svg" style="width: 1rem; margin-left .5rem;"/></span></div><div class="company-info"> <img class="polyreg-image" src="/img/polyreg-52ec37fb80d0312b219110c05567ad3d.png" alt="Polyreg logo" width="120"/><p>Peach is an SRO member (Self Regulatory Organisation) of Polyreg </p><p>Peach is a Swiss licensed financial service provider and is fully compliant with Switzerland’s Anti-Money Laundering Act. </p></div></div><div class="content"><div class="footer-box"><h6>Company</h6><a href="/join-us/">Join Us</a><a href="/terms-and-conditions/">Terms and Conditions</a><a href="/privacy-policy/">Privacy Policy</a><a class="cookie-link" href="#" onclick="showCookiePopup(event)">Manage Cookie Preferences</a></div><div class="footer-box"><h6>Contact</h6><a href="mailto:hello@peachbitcoin.com">Email</a><a href="https://keys.openpgp.org/vks/v1/by-fingerprint/48339A19645E2E53488E0E5479E1B270FACD1BD2">PGP Key</a></div><div class="footer-box"><h6>Download</h6><span>0.69.0 (312)</span><a href="/apk/">APK</a><a href="https://testflight.apple.com/join/wfSPFEWG">iPhone</a><a href="https://play.google.com/store/apps/details?id=com.peachbitcoin.peach.mainnet">Android</a></div><div class="footer-box"><h6>Community</h6><a href="https://twitter.com/peachbitcoin" target="_blank" rel="noreferrer noopener">Twitter</a><a href="https://t.me/peachtopeach" target="_blank" rel="noreferrer noopener">Telegram</a><a href="https://discord.gg/ypeHz3SW54" target="_blank" rel="noreferrer noopener">Discord</a><a href="https://www.instagram.com/peachbitcoin/" target="_blank" rel="noreferrer noopener">Instagram</a><a href="https://snort.social/p/npub15369wu3wzzar5fclhecyqfv683x69n6nhlg7rxqnsg2dydgxflpq3apswl" target="_blank" rel="noreferrer noopener">Nostr</a><a href="https://github.com/Peach2Peach" target="_blank" rel="noreferrer noopener">Github</a><a href="https://www.youtube.com/@peachbitcoin" target="_blank" rel="noreferrer noopener">YouTube</a></div><div class="footer-box"><h6>Bitcoin</h6><a href="/bitcoin.pdf">Whitepaper</a><a href="https://docs.peachbitcoin.com">API Documentation</a></div><div class="footer-box"><h6>Earn Bitcoin</h6><a href="/new-users/">Referral Code</a><a href="/for-businesses/">Become an Affiliate</a></div></div></div></footer><style>#cookie-banner {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #120A07;
  color: #fff;
  padding: 15px 0;
  z-index: 9999;
  font-size: 14px;
}
#cookie-banner .cookie-container {
  width: 90%;
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
}
#cookie-banner p {
  margin: 0;
  line-height: 1.4;
}
#cookie-banner .cookie-actions {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}
#cookie-banner button {
  padding: 10px 16px;
  color: #fff;
  background-color: #65A519;
  border: none;
  cursor: pointer;
  border-radius: 4px;
  font-size: 14px;
  transition: background-color 0.3s ease;
}
#cookie-banner button:hover {
  background-color: #65A519;
}
#cookie-banner button.reject {
  background-color: #DF321F;
}
#cookie-banner button.reject:hover {
  background-color: #DF321F;
}
#cookie-banner a.cookie-link {
  color: #fff;
  text-decoration: underline;
  font-size: 14px;
  margin-left: 8px;
  cursor: pointer;
}
#cookie-banner a.cookie-link:hover {
  text-decoration: none;
}
/* Popup overlay */
#cookie-popup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  z-index: 10000;
  justify-content: center;
  align-items: center;
  color: #fff;
}
/* Contenitore del popup */
#cookie-popup-content {
  position: relative;
  background-color: #120A07;
  color:rgb(255, 255, 255);
  padding: 30px 20px 20px;
  border-radius: 10px;
  width: 80%;
  max-width: 600px;
  box-sizing: border-box;
}
/* Pulsante di chiusura */
#cookie-popup-content .close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  color: #fff;
  font-size: 24px;
  line-height: 1;
  cursor: pointer;
  padding: 0 5px;
}
#cookie-popup-content .close-btn:hover {
  color: #ccc;
}
/* Stile per ciascuna categoria di cookie */
.cookie-category {
  margin-bottom: 20px;
}
/* Migliora i checkbox e le label */
.cookie-category label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 15px;
}
.cookie-category input[type="checkbox"] {
  accent-color: #4CAF50;
  margin: 0;
  cursor: pointer;
}
.cookie-category p {
  margin: 4px 0 0 28px;
  font-size: 14px;
  line-height: 1.4;
  color: #ccc;
}
/* Bottone "Salva Preferenze" */
#cookie-popup-content button.save-btn {
  background-color: #4CAF50;
  border: none;
  padding: 10px 16px;
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  border-radius: 4px;
  transition: background-color 0.3s ease;
}
#cookie-popup-content button.save-btn:hover {
  background-color: #43a047;
}
/* Media query per schermi più piccoli */
@media (max-width: 768px) {
  #cookie-banner .cookie-container {
    flex-direction: column;
    align-items: flex-start;
  }
  #cookie-banner .cookie-actions {
    margin-top: 10px;
    width: 100%;
    justify-content: flex-start;
    gap: 8px;
    flex-wrap: wrap;
  }
}

</style><div id="cookie-banner" style="display: none;"><div class="cookie-container"><p>We use cookies to improve your experience. <a href="/privacy-policy" style="color: #4CAF50;">Read more</a></p><div class="cookie-actions"><button class="cookie-btn" onclick="acceptCookies()">Accept Cookies &amp; Continue</button><button class="cookie-btn reject" onclick="rejectCookies()">Reject Cookies</button><a class="cookie-link" href="#" onclick="showCookiePopup(event)">Manage Cookies</a></div></div></div><div id="cookie-popup"><div id="cookie-popup-content"><button class="close-btn" type="button" onclick="closeCookiePopup()">×</button><h2>Manage cookie preferences</h2><div class="cookie-category"><div class="switch-container"><span class="label-text">Necessary Cookies</span><label class="switch" for="necessary-cookies"><input type="checkbox" id="necessary-cookies" checked="checked" disabled="disabled"/><span class="slider"></span></label></div><p>These cookies are essential for the website's operation.</p></div><div class="cookie-category"><div class="switch-container"><span class="label-text">Analytics Cookies</span><label class="switch" for="analytics-cookies"><input type="checkbox" id="analytics-cookies"/><span class="slider"></span></label></div><p>Analytics cookies help us understand how users interact with the site.</p></div><div class="cookie-category"><div class="switch-container"><span class="label-text">Marketing Cookies</span><label class="switch" for="marketing-cookies"><input type="checkbox" id="marketing-cookies"/><span class="slider"></span></label></div><p>Marketing cookies are used to collect users information</p></div><div style="text-align: right; margin-top: 20px;"><button class="save-btn" type="button" onclick="savePreferences()">Save Preferences</button></div></div></div><script src="/js/main-15c0432b5e5f06cbab9e3fedcaae3032.js"></script><script>if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/service-worker.js')
      .then(function(registration) {
        console.log('Service Worker registrato con successo:', registration);
      })
      .catch(function(error) {
        console.log('Registrazione del Service Worker fallita:', error);
      });
  });
} else {
  console.log('Service Worker non supportato in questo browser.');
}
</script><script>document.addEventListener('DOMContentLoaded', function () {
  // Map of language codes to display names
  const languageMap = {
    en: 'English',
    es: 'Español',
    de: 'Deutsch',
    it: 'Italiano',
    fr: 'Français',
    el: 'Ελληνικά',
    hu: 'Magyar',
    nl: 'Nederlands',
    pl: 'Polski',
    pt: 'Português',
    sw: 'Kiswahili',
    uk: 'Українська'
  };

  // Detect current lang from path
  const path = window.location.pathname.replace(/\/+$/, ''); // trim trailing slash
  let currentLang = 'en';
  for (const code in languageMap) {
    if (path === '/' && code === 'en') { currentLang = 'en'; break; }
    if (path === `/${code}` || path.startsWith(`/${code}/`)) { currentLang = code; break; }
  }

  const label = document.querySelector('.language-label');
  if (!label) return;

  // Ensure there is a span.language-text, create it if missing
  let textNode = label.querySelector('.language-text');
  if (!textNode) {
    textNode = document.createElement('span');
    textNode.className = 'language-text';
    // insert before the dropdown chevron if present
    // const chevron = Array.from(label.querySelectorAll('img')).find(img => /dropdown_icon\.svg(\?.*)?$/i.test(img.getAttribute('src') || ''));
    label.insertBefore(textNode, chevron || null);
  }

  // Set the text
  textNode.textContent = languageMap[currentLang] || currentLang.toUpperCase();

  // Remove any flag images inside the label (keep the chevron)
  //- Array.from(label.querySelectorAll('img')).forEach(img => {
  //-   const src = img.getAttribute('src') || '';
  //-   const isChevron = /dropdown_icon\.svg(\?.*)?$/i.test(src);
  //-   if (!isChevron) {
  //-     img.remove();
  //-   }
  //- });

  // Also nuke any pseudo-element flags applied via CSS (belt & suspenders)
  label.style.backgroundImage = 'none';
});

</script><script>(function() {
  // Funzioni di utilità per gestire i cookie
  function setCookie(name, value, days) {
    var expires = "";
    if (days) {
      var date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
  }

  function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }

  // Controlla se il consenso è già stato dato per nascondere il banner
  function checkConsent() {
    if (getCookie('consent_necessary') === "true") {
      document.getElementById('cookie-banner').style.display = 'none';
    } else {
      document.getElementById('cookie-banner').style.display = 'flex';
    }
  }

  // Funzione per accettare tutti i cookie
  window.acceptCookies = function() {
    setCookie('consent_necessary', 'true', 365);
    setCookie('consent_analytics', 'true', 365);
    setCookie('consent_marketing', 'true', 365);
    document.getElementById('cookie-banner').style.display = 'none';
    document.getElementById('cookie-popup').style.display = 'none';
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({event: 'cookie_consent', consent_analytics: true, consent_marketing: true});
  };

  // Funzione per rifiutare cookie opzionali (analytics e marketing)
  window.rejectCookies = function() {
    setCookie('consent_necessary', 'true', 365);
    setCookie('consent_analytics', 'false', 365);
    setCookie('consent_marketing', 'false', 365);
    document.getElementById('cookie-banner').style.display = 'none';
    document.getElementById('cookie-popup').style.display = 'none';
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({event: 'cookie_consent', consent_analytics: false, consent_marketing: false});
  };

  // Mostra il popup per gestire le preferenze dei cookie
  window.showCookiePopup = function(event) {
    event.preventDefault();
    document.getElementById('cookie-popup').style.display = 'flex';
  };
  window.closeCookiePopup = function() {
  document.getElementById('cookie-popup').style.display = 'none';
  };

  // Salva le preferenze impostate nel popup
  window.savePreferences = function() {
    var analyticsConsent = document.getElementById('analytics-cookies').checked;
    var marketingConsent = document.getElementById('marketing-cookies').checked;
    setCookie('consent_necessary', 'true', 365);
    setCookie('consent_analytics', analyticsConsent ? 'true' : 'false', 365);
    setCookie('consent_marketing', marketingConsent ? 'true' : 'false', 365);
    document.getElementById('cookie-banner').style.display = 'none';
    document.getElementById('cookie-popup').style.display = 'none';
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({event: 'cookie_consent', consent_analytics: analyticsConsent, consent_marketing: marketingConsent});
  };

  // Inizializza il controllo del consenso al caricamento della pagina
  checkConsent();
})();</script></body></html>